// resources/js/Components/RussianPostMap.tsx - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ –ü–æ—á—Ç—ã –†–æ—Å—Å–∏–∏
import { useEffect } from 'react';
import { useExternalScript } from '@/Hooks/useExternalScript';
import { toast } from 'react-toastify';
import { Slide, Zoom, Flip, Bounce } from 'react-toastify';
// import { Helmet } from "react-helmet";

declare global {                        // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  interface Window {                    // –ß—Ç–æ –¥–µ–ª–∞–µ—Ç: –†–∞—Å—à–∏—Ä—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Window
    ecomStartWidget?: (config: {        // –¥–æ–±–∞–≤–ª—è—è –≤ –Ω–µ–≥–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é (?) —Ñ—É–Ω–∫—Ü–∏—é ecomStartWidget.
      id: number;                       // –ó–∞—á–µ–º: TypeScript –±—É–¥–µ—Ç "–∑–Ω–∞—Ç—å" –æ–± —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, 
      callbackFunction: Function;       // –∫–æ–≥–¥–∞ –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞.
      containerId: string;
    }) => void;
  }
}

interface RussianPostMapProps {
  onSelect: (data: any) => void;
}

const RussianPostMap = ({ onSelect }: RussianPostMapProps) => {

    const toastConfig = {
        position: "top-right" as const,
        autoClose: 1500, // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É-–¥—Ä—É–≥—É—é...
        hideProgressBar: true,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        transition: Slide, // –ò—Å–ø–æ–ª—å–∑—É–µ–º Slide, Zoom, Flip, Bounce –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ—Å—Ç–∞
    }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞
  useExternalScript('https://widget.pochta.ru/map/widget/widget.js');
  // 1. –•—É–∫ useExternalScript - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç <script> —Ç–µ–≥ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ <body>.

  // 2. –î–æ–±–∞–≤–ª—è–µ–º Helmet –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ fallback-–∑–∞–≥—Ä—É–∑–∫–∏ - –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–æ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ - –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –Ω–∞ –ø–∞–º—è—Ç—å:
  /*  <Helmet>
    <script 
        src="https://widget.pochta.ru/map/widget/widget.js" 
        async 
        onError={() => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –ü–æ—á—Ç—ã –†–æ—Å—Å–∏–∏')}
    />
    </Helmet> */

  useEffect(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∂–µ—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
    const initWidget = () => {
      if (window.ecomStartWidget) {             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞.
        window.ecomStartWidget({                // –í—ã–∑—ã–≤–∞–µ–º –µ—ë —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
          id: 50063,                            // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–∞ (50063).
          callbackFunction: onSelect,           // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–µ–Ω–∏—è.
          containerId: 'ecom-widget'            // ID DOM-—ç–ª–µ–º–µ–Ω—Ç–∞, –∫—É–¥–∞ –≤—Å—Ç—Ä–æ–∏—Ç—Å—è –≤–∏–¥–∂–µ—Ç.
        });
      }
    };

    /*// –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ Helmet)
    if (window.ecomStartWidget) {
        initWidget();
        return;
    }*/

    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –∫–∞–∫ fallback - –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 100–º—Å
    const interval = setInterval(() => {
      if (window.ecomStartWidget) {             // 
        clearInterval(interval);
        initWidget();
      }
    }, 100);
    
    /** –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è useExternalScript —Å–∫—Ä–∏–ø—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è, –Ω–æ: 
     *      - –ú—ã –Ω–µ –∑–Ω–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∑–∞–π–º—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)... 
     *      - –ù–µ –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å onload –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ö—É–∫...
     *  –†–µ—à–µ–Ω–∏–µ: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º (–∫–∞–∂–¥—ã–µ 100 –º—Å), –ø–æ—è–≤–∏–ª–∞—Å—å –ª–∏ –Ω—É–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ window.
     *  –ü–æ—á–µ–º—É 100 –º—Å? –≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:
     *      - –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ (1-10 –º—Å): –ë–µ—Å–ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±—Ä–∞—É–∑–µ—Ä.
     *      - –°–ª–∏—à–∫–æ–º —Ä–µ–¥–∫–æ (5 –º–∏–Ω): –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞.
     *      - 100 –º—Å: –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ + –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UX.
     *  –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã:
     *      - –°–∫—Ä–∏–ø—Ç –æ–±—ã—á–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–∞ 100-500 –º—Å.
     *      - –ï—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
     *      - –õ–æ–≥–∏—á–Ω–µ–µ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É" —á–µ—Ä–µ–∑ 2-3 —Å–µ–∫—É–Ω–¥—ã.  
     */

    // –ü–æ—Å–ª–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π, –∏–∑–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤—ã—à–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ—â—ë –∏ —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤–∏–¥–∂–µ—Ç–∞:
    useEffect(() => {
        const timeout = setTimeout(() => {
        if (!window.ecomStartWidget) {
            toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...', toastConfig);
            clearInterval(interval);
        }
        }, 2000); // –ñ–¥—ë–º –º–∞–∫—Å–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã
    
        return () => {
        clearInterval(interval);
        clearTimeout(timeout);
        };
    }, []);

    return () => clearInterval(interval);       // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    // –ó–∞—á–µ–º: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–π–¥—ë—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞, –∏–Ω—Ç–µ—Ä–≤–∞–ª –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏.
  }, [onSelect]);

  return (
    <div className="russianpost-map__content">
      <p className="russianpost-map__content-text">
        –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ä–æ–∫–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏:
      </p>
      <div id="ecom-widget" className="russianpost-map" />
      <div className="map__params"></div>
    </div>
  );
};

export default RussianPostMap;

/** üõ† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—Å—å –ø–æ—Ç–æ–∫
        - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" ‚Üí –†–µ–Ω–¥–µ—Ä–∏—Ç—Å—è <RussianPostMap>.
        - –•—É–∫ useExternalScript –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å widget.js.
        - –ü–æ–∫–∞ —Å–∫—Ä–∏–ø—Ç –≥—Ä—É–∑–∏—Ç—Å—è, useEffect –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª:
        - –ö–∞–∂–¥—ã–µ 100 –º—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç window.ecomStartWidget.
        - –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π:
        - –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—â–∞–µ—Ç—Å—è.
        - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è initWidget().
        - –í–∏–¥–∂–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ div#ecom-widget.
    –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç onSelect(data).
*/